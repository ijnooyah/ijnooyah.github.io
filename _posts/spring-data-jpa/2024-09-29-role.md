---
title: "[Spring Data JPA] ë‹¤ì¤‘ ê¶Œí•œ í”„ë¡œì íŠ¸"
excerpt: ""

categories:
  - Spring Data JPA
tags:
  - [Spring Data JPA]

permalink: /spring-data-jpa/role

toc: true
toc_sticky: true

date: 2024-09-29
last_modified_at: 2024-09-29
---

# ğŸ‘‹ ì†Œê°œ

ë‚˜ì¤‘ì— êµ¬í˜„í•  í”„ë¡œì íŠ¸ì—ì„œ DB, RedisëŠ” AWSì˜ ì„œë¹„ìŠ¤ë¥¼ ì‚¬ìš©í•  ì˜ˆì •ì´ë¼ ë„ì»¤ì—ì„œ MySQLê³¼ Redisë¥¼ ì»¨í…Œì´ë„ˆë¡œ ì„¤ì¹˜í•´ì„œ ì‹¤í–‰í–ˆë‹¤.
ì°¸ê³ ë¡œ Redisë¥¼ ì»¨í…Œì´ë„ˆë¡œ ì‹¤í–‰í• ê²ƒì´ë¼ ê¸°ì¡´ì— OSì— ì„¤ì¹˜ëœ RedisëŠ” ì‚­ì œí–ˆë‹¤.

ì „ì²´ ì½”ë“œëŠ” [ê¹ƒí—ˆë¸Œ](https://github.com/ijnooyah/admin-project)ì—ì„œ ë³¼ ìˆ˜ ìˆìœ¼ë©°, ì „ì²´ ì½”ë“œë¥¼ ë‹¤ ì„¤ëª…í•˜ì§€ ì•Šê³  ì£¼ìš” ë¶€ë¶„ë§Œ ì„¤ëª…í–ˆë‹¤.

---

# ğŸ“Š ë„ë©”ì¸ ëª¨ë¸ê³¼ í…Œì´ë¸”

**ë„ë©”ì¸ ëª¨ë¸ì€ ë‹¤ìŒê³¼ ê°™ë‹¤:**

![alt text](/assets/images/posts_img/spring-data-jpa/role/domain.png)

**ì‚¬ìš©ì(User):** ì‚¬ìš©ìì™€ ì‚¬ìš©ìê¶Œí•œ(`UserRole`)ì€ ì¼ëŒ€ë‹¤ ê´€ê³„ì´ë‹¤. ì‚¬ìš©ìì˜ ì•„ì´ë””ì¸ ì´ë©”ì¼, ë¹„ë°€ë²ˆí˜¸, ë‹‰ë„¤ì„, ì‚¬ì§„, í”„ë¡œë°”ì´ë”, ì‚­ì œ ì—¬ë¶€, ì‚­ì œ ì‹œê°„, í”„ë¡œë°”ì´ë”(`ProviderType`)ì„ ê°€ì§€ê³  ìˆë‹¤. í”„ë¡œë°”ì´ë”ëŠ” ë¡œì»¬(`Local`), êµ¬ê¸€(`GOOGLE`), ë„¤ì´ë²„(`NAVER`)ê°€ ìˆë‹¤.

**ì‚¬ìš©ìê¶Œí•œ(UserRole):** ì‚¬ìš©ì(`User`)ì™€ ê¶Œí•œ(`Role`)ì„ ê°€ì§€ê³  ìˆë‹¤.

**ê¶Œí•œ(Role):** ê¶Œí•œëª…ì„ ê°€ì§€ê³  ìˆë‹¤. 

<br>

**ì´ì— ë”°ë¥¸ í…Œì´ë¸”ì€ ë‹¤ìŒê³¼ ê°™ë‹¤:**

![alt text](/assets/images/posts_img/spring-data-jpa/role/admin_project.png)

---

# ğŸ—ï¸ ì—”í‹°í‹°

## â° BaseTimeEntity
```java
@Getter
@EntityListeners(AuditingEntityListener.class)
@MappedSuperclass
public abstract class BaseTimeEntity {

    @CreatedDate
    @Column(updatable = false)
    private LocalDateTime createdAt;

    @LastModifiedDate
    private LocalDateTime updatedAt;
}
```
**@MappedSuperclass**  
  - JPA ì–´ë…¸í…Œì´ì…˜ìœ¼ë¡œ, ì´ í´ë˜ìŠ¤ê°€ ë‹¨ë…ìœ¼ë¡œ ì‚¬ìš©ë˜ì§€ ì•Šê³  ë‹¤ë¥¸ ì—”í‹°í‹° í´ë˜ìŠ¤ë“¤ì˜ ê³µí†µ ë§¤í•‘ ì •ë³´ë¥¼ ì œê³µí•˜ëŠ” ìƒìœ„ í´ë˜ìŠ¤ì„ì„ ë‚˜íƒ€ë‚¸ë‹¤.
  - ì´ í´ë˜ìŠ¤ë¥¼ ìƒì†ë°›ëŠ” ì—”í‹°í‹°ë“¤ì€ ì—¬ê¸°ì— ì •ì˜ëœ í•„ë“œë“¤ì„ ìë™ìœ¼ë¡œ ì»¬ëŸ¼ìœ¼ë¡œ ê°–ê²Œ ëœë‹¤.

**@EntityListeners(AuditingEntityListener.class)**
  - JPA ì—”í‹°í‹° ë¦¬ìŠ¤ë„ˆë¥¼ ì§€ì •í•˜ëŠ” ì–´ë…¸í…Œì´ì…˜ì´ë‹¤.
  - `AuditingEntityListener`ëŠ” ì—”í‹°í‹°ì˜ ìƒì„±ì¼ì‹œì™€ ìˆ˜ì •ì¼ì‹œë¥¼ ìë™ìœ¼ë¡œ ê´€ë¦¬í•´ì£¼ëŠ” ë¦¬ìŠ¤ë„ˆë‹¤. ì´ ë¦¬ìŠ¤ë„ˆëŠ” ì—”í‹°í‹°ê°€ ì €ì¥ë˜ê±°ë‚˜ ìˆ˜ì •ë  ë•Œ ìë™ìœ¼ë¡œ í˜¸ì¶œë˜ì–´ `@CreatedDate`ì™€ `@LastModifiedDate` ì–´ë…¸í…Œì´ì…˜ì´ ë¶™ì€ í•„ë“œë¥¼ í˜„ì¬ ì‹œê°„ìœ¼ë¡œ ì„¤ì •í•œë‹¤.

**@Column(updatable = false)**
  - JPA ì–´ë…¸í…Œì´ì…˜ìœ¼ë¡œ, ë°ì´í„°ë² ì´ìŠ¤ì˜ ì»¬ëŸ¼ê³¼ ë§¤í•‘ë¨ì„ ë‚˜íƒ€ë‚¸ë‹¤.
  - `updatable = false`ëŠ” ì´ í•„ë“œê°€ í•œ ë²ˆ ì €ì¥ëœ í›„ì—ëŠ” ê°±ì‹ ë˜ì§€ ì•ŠìŒì„ ì˜ë¯¸í•œë‹¤.

> **ë¦¬ìŠ¤ë„ˆë€?**  
ë¦¬ìŠ¤ë„ˆ(Listener)ëŠ” íŠ¹ì • ì´ë²¤íŠ¸ê°€ ë°œìƒí–ˆì„ ë•Œ ìë™ìœ¼ë¡œ í˜¸ì¶œë˜ëŠ” ë©”ì„œë“œë¥¼ ê°€ì§„ ê°ì²´ë¥¼ ë§í•œë‹¤.  
**JPA ì»¨í…ìŠ¤íŠ¸ì—ì„œ ë¦¬ìŠ¤ë„ˆ**ëŠ” ì—”í‹°í‹°ì˜ ìƒëª…ì£¼ê¸° ë™ì•ˆ ë°œìƒí•˜ëŠ” ë‹¤ì–‘í•œ ì´ë²¤íŠ¸ë¥¼ ê°ì§€í•˜ê³  ë°˜ì‘í•˜ëŠ” ì—­í• ì„ í•œë‹¤.
{: .info}

---
{: .style1}

## ğŸ‘¤ User
```java
@Entity
@Table(name = "users")
@NoArgsConstructor(access = AccessLevel.PROTECTED)
@Getter
public class User extends BaseTimeEntity {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    @Column(name = "user_id")
    private Long id;

    private String nickname;
    private String email;
    private String picture;
    private String password;

    @Enumerated(EnumType.STRING)
    private ProviderType provider;

    @OneToMany(mappedBy = "user", cascade = CascadeType.ALL, orphanRemoval = true)
    private Set<UserRole> userRoles = new HashSet<>();

    private boolean deleted;

    private LocalDateTime deletedAt;

    // == ì—°ê´€ê´€ê³„ ë©”ì„œë“œ ==
    public void addUserRole(UserRole userRole) {
        this.userRoles.add(userRole);
        userRole.updateUser(this);
    }

    // == ìƒì„± ë©”ì„œë“œ ==
    public static <T extends UserRequest> User createLocalUser(T  request, PasswordEncoder passwordEncoder, Set<UserRole> userRoles) {
        User user = new User();
        user.email = request.getEmail();
        user.nickname = request.getNickname();
        user.password = passwordEncoder.encode(request.getPassword());
        user.picture = request.getPicture();
        user.provider = ProviderType.LOCAL;
        user.deleted = false;
        for (UserRole userRole : userRoles) {
            user.addUserRole(userRole);
        }
        return user;
    }

    public static User createOAuthUser(OAuthAttributes attributes, Set<UserRole> userRoles) {
        User user = new User();
        user.email = attributes.getEmail();
        user.nickname = attributes.getNickname();
        user.picture = attributes.getPicture();
        user.provider = ProviderType.getProviderType(attributes.getRegistrationId());
        user.deleted = false;
        for (UserRole userRole : userRoles) {
            user.addUserRole(userRole);
        }
        return user;
    }

    // == ìˆ˜ì • ë©”ì„œë“œ ==
    public <T extends UserRequest> User update(T request) {
        this.nickname = request.getNickname();
        this.picture = request.getPicture();
        return this;
    }

    public void updatePassword(String rawPassword, PasswordEncoder passwordEncoder) {
        if (rawPassword != null && !rawPassword.isEmpty()) {
            this.password = passwordEncoder.encode(rawPassword);
        }
    }

    // == ì‚­ì œ ë©”ì„œë“œ ==
    public void delete() {
        this.deleted = true;
        this.deletedAt = LocalDateTime.now();
    }

}
```

**@Table(name = "users")**
  - ë°ì´í„°ë² ì´ìŠ¤ì˜ "users" í…Œì´ë¸”ê³¼ ë§¤í•‘ëœë‹¤.
  
**@NoArgsConstructor(access = AccessLevel.PROTECTED)**
  - ì¸ì ì—†ëŠ” ìƒì„±ìë¥¼ protectedë¡œ ìƒì„±í•œë‹¤. ê¸°ë³¸ ìƒì„±ìë¥¼ ë§‰ì•„ ê°’ ë³€ê²½ ëª©ì ìœ¼ë¡œ ì ‘ê·¼í•˜ëŠ” ê²ƒì„ ì°¨ë‹¨í•œë‹¤.

**@Enumerated(EnumType.STRING)**
  - JPAì—ì„œ Java enum íƒ€ì…ì„ ë°ì´í„°ë² ì´ìŠ¤ ì¹¼ëŸ¼ì— ë§¤í•‘í•  ë•Œ ì‚¬ìš©í•˜ëŠ” ì–´ë…¸í…Œì´ì…˜ì´ë‹¤.
  - ê¸°ë³¸ì ìœ¼ë¡œëŠ” intë¡œ ëœ ìˆ«ìê°€ ì €ì¥ëœë‹¤. ìˆ«ìë¡œ ì €ì¥ë˜ë©´ ë°ì´í„°ë² ì´ìŠ¤ë¡œ í™•ì¸í•  ë•Œ ê·¸ ê°’ì´ ë¬´ìŠ¨ ì½”ë“œë¥¼ ì˜ë¯¸í•˜ëŠ”ì§€ ì•Œ ìˆ˜ê°€ ì—†ë‹¤.
  - ë”°ë¼ì„œ ë¬¸ìì—´(`EnumType.STRING`)ë¡œ ì €ì¥ë  ìˆ˜ ìˆë„ë¡ ì„ ì–¸í•œë‹¤.

**@OneToMany(mappedBy = "user", cascade = CascadeType.ALL, orphanRemoval = true)**
  - `mappedBy = "user"`
    - ì–‘ë°©í–¥ ì—°ê´€ê´€ê³„ì—ì„œ UserRole ì—”í‹°í‹°ê°€ ì´ ê´€ê³„ì˜ ì£¼ì¸ì„ì„ ë‚˜íƒ€ë‚¸ë‹¤.
    - ì‹¤ì œ ì™¸ë˜ í‚¤ëŠ” UserRole í…Œì´ë¸”ì— ì¡´ì¬í•¨ì„ ì˜ë¯¸í•œë‹¤.
  - `cascade = CascadeType.ALL`
    - ìºìŠ¤ì¼€ì´ë“œ ì˜µì…˜ì€ ë¶€ëª¨ ì—”í‹°í‹°(User)ì˜ íŠ¹ì • ë™ì‘ì„ ìì‹ ì—”í‹°í‹°(UserRole)ì—ë„ ì „íŒŒí• ì§€ ê²°ì •í•œë‹¤.
    - `CascadeType.ALL`ì€ ëª¨ë“  ì¢…ë¥˜ì˜ ë°ì´í„°ë² ì´ìŠ¤ ì‘ì—…(ì €ì¥, ìˆ˜ì •, ì‚­ì œ ë“±)ì´ User ì—”í‹°í‹°ì—ì„œ UserRole ì—”í‹°í‹°ë¡œ ì „íŒŒë¨ì„ ì˜ë¯¸í•œë‹¤.
  - `orphanRemoval = true`
    - ë¶€ëª¨ ì—”í‹°í‹°(User)ì™€ì˜ ê´€ê³„ê°€ ëŠì–´ì§„ ìì‹ ì—”í‹°í‹°(UserRole)ë¥¼ ìë™ìœ¼ë¡œ ì‚­ì œí•˜ë„ë¡ ì§€ì‹œí•œë‹¤.
    - User ì—”í‹°í‹°ì˜ userRoles ì»¬ë ‰ì…˜ì—ì„œ íŠ¹ì • UserRoleì„ ì œê±°í•˜ë©´, ê·¸ UserRole ì—”í‹°í‹°ëŠ” ë°ì´í„°ë² ì´ìŠ¤ì—ì„œë„ ì‚­ì œëœë‹¤.
  
**addUserRole()**
  - Userì™€ UserRoleì€ ì–‘ë°©í–¥ ì—°ê´€ê´€ê³„ì´ë‹¤. 
  - UserRoleì´ ì—°ê´€ê´€ê³„ì˜ ì£¼ì¸ì´ë‹¤. Userì˜ userRolesì— ê°’ì„ ì¶”ê°€í•  ë•Œ ìˆœìˆ˜í•œ ê°ì²´ ê´€ê³„ë¥¼ ê³ ë ¤í•˜ë©´ ì–‘ìª½ì— ë‹¤ ê°’ì„ ë„£ì–´ì£¼ì–´ì•¼ í•œë‹¤.
  - ë”°ë¼ì„œ ì—°ê´€ê°„ê³„ì˜ ì£¼ì¸ì¸ userRoleì—ë„ Userì„ ì„¤ì •í•´ì¤€ë‹¤. (`userRole.updateUser(this)`)

**createLocalUser()**
  - `ProviderType.LOCAL`ì¸ Userì„ ìƒì„±í•˜ëŠ” ë©”ì„œë“œë‹¤.
  - ì œë„ˆë¦­ ë©”ì„œë“œë¥¼ ì‚¬ìš©í•´ `UserRequest`ì˜ í•˜ìœ„ íƒ€ì…ì¸ DTOë“¤ì´ íŒŒë¼ë¯¸í„°ë¡œ ë“¤ì–´ì˜¬ ìˆ˜ ìˆê²Œ í•´ì£¼ì—ˆë‹¤.

**createOAuthUser()**
  - ì†Œì…œ ë¡œê·¸ì¸ì„ í†µí•´ ê°€ì…í•˜ëŠ” Userì„ ìƒì„±í•˜ëŠ” ë©”ì„œë“œë‹¤.

â“ **`AccessLevel.PROTECTED`ë¡œ ì„¤ì •í•œ ì´ìœ :**  
JPAì—ì„œ ì—”í‹°ë¦¬ë¥¼ í”„ë¡ì‹œ ê°ì²´ë¡œ ìƒì„±í•˜ëŠ” ë°©ì‹ê³¼ ê´€ë ¨ì´ ìˆë‹¤.  
JPA êµ¬í˜„ì²´ëŠ” ì§€ì—° ë¡œë”©(lazy loading)ì„ ì‚¬ìš©í•  ë•Œ ì‹¤ì œ ì—”í‹°í‹°ë¥¼ ì¡°íšŒí•˜ëŠ” ëŒ€ì‹ ì— **í”„ë¡ì‹œ ê°ì²´**ë¥¼ ë°˜í™˜í•œë‹¤. ì´ í”„ë¡ì‹œ ê°ì²´ëŠ” ì—”í‹°í‹°ì˜ ê¸°ë³¸ ìƒì„±ìë¥¼ í˜¸ì¶œí•´ì„œ ë§Œë“¤ì–´ì§€ëŠ”ë°, ê¸°ë³¸ ìƒì„±ìê°€ `private`ë¡œ ì„¤ì •ë˜ì–´ ìˆìœ¼ë©´ JPAê°€ ì´ìƒì„±ìì— ì ‘ê·¼í•  ìˆ˜ ì—†ê¸° ë•Œë¬¸ì— í”„ë¡ì‹œ ê°ì²´ë¥¼ ìƒì„±í•  ìˆ˜ ì—†ë‹¤. ë”°ë¼ì„œ, ì—”í‹°í‹° í´ë˜ìŠ¤ì—ì„œëŠ” `protected`ë¡œ ê¸°ë³¸ ìƒì„±ìë¥¼ ë‘ëŠ” ê²ƒì´ ê´€ë¡€ì´ë‹¤.  
ì´ëŠ” ì™¸ë¶€ì—ì„œ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì§ì ‘ ìƒì„±í•˜ëŠ” ê²ƒì„ ë§‰ìœ¼ë©´ì„œë„ JPAì™€ ê°™ì€ í”„ë ˆì„ì›Œí¬ê°€ ê¸°ë³¸ ìƒì„±ìì— ì ‘ê·¼í•  ìˆ˜ ìˆë„ë¡ í•˜ê¸° ìœ„í•¨ì´ë‹¤.

---
{: .style1}

## ğŸ­ UserRole
```java
@Entity
@Table(name = "user_role")
@NoArgsConstructor(access = AccessLevel.PROTECTED)
@Getter
public class UserRole extends BaseTimeEntity {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    @Column(name = "user_role_id")
    private Long id;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "user_id")
    private User user;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "role_id")
    private Role role;

    public void updateUser(User user) {
        this.user = user;
    }

    // ìƒì„± ë©”ì„œë“œ
    public static UserRole createUserRole(Role role) {
        UserRole userRole = new UserRole();
        userRole.role = role;
        return userRole;
    }
}
```

**@ManyToOne(fetch = FetchType.LAZY)**
- `FetchType.LAZY`
  - @ManyToOne ì–´ë…¸í…Œì´ì…˜ì€ ê¸°ë³¸ì´ `FetchType.EAGER`ì´ê¸° ë•Œë¬¸ì— ì§€ì—°ë¡œë”©ìœ¼ë¡œ ì„¤ì •í•´ì¤€ë‹¤.

---
{: .style1}

## ğŸ·ï¸ Role
```java
@Entity
@NoArgsConstructor(access = AccessLevel.PROTECTED)
@Getter
public class Role  extends BaseTimeEntity {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    @Column(name = "role_id")
    private Long id;

    @Column(name = "role_name")
    private String name;

    public Role(String name) {
        this.name = name;
    }
}
```

---

# ğŸ“œ ê¶Œí•œ ë°ì´í„° ì´ˆê¸°í™”

ì²˜ìŒì—ëŠ” `CommandLineRunner`ë¥¼ ì´ìš©í•´ ê¶Œí•œ ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í–ˆëŠ”ë°, ë³µì¡í•œ ë¡œì§ì´ í•„ìš”í•˜ì§€ ì•Šì•„ì„œ `spring.sql.init.mode` ì˜µì…˜ì„ í™œìš©í•˜ê¸°ë¡œ í–ˆë‹¤.

```yml
spring:
  jpa:
    defer-datasource-initialization: true

  sql:
    init:
      mode: always
```
- `spring.jpa.defer-datasource-initialization`ë¥¼ `true`ë¡œ ì„¤ì •í•˜ë©´,
   Hibernateì˜ ìŠ¤í‚¤ë§ˆ ìƒì„± ì´í›„ì— ë°ì´í„° ì†ŒìŠ¤ ì´ˆê¸°í™”(SQL ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰)ê°€ ìˆ˜í–‰ëœë‹¤.
   ì¦‰ `spring.jpa.ddl-auto` ì„¤ì •ì— ëŒ€í•œ ê²ƒì´ ìˆ˜í–‰ëœ í›„ ì‹¤í–‰ëœë‹¤ëŠ” ê²ƒì´ë‹¤.
- `spring.sql.init.mode`ëŠ” ë°ì´í„° ì´ˆê¸°í™” ì‹œì ì„ ê²°ì •í•˜ëŠ” ì˜µì…˜ìœ¼ë¡œ ë‹¤ìŒ ì„¸ê°€ì§€ ê°’ì„ ê°€ì§„ë‹¤.
  - `always`: ëª¨ë“  ë°ì´í„°ë² ì´ìŠ¤ì— ëŒ€í•´ í•­ìƒ ì´ˆê¸°í™” ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‹¤í–‰í•œë‹¤.
  - `embedded` - ê¸°ë³¸ê°’ìœ¼ë¡œ ë‚´ì¥ ë°ì´í„°ë² ì´ìŠ¤ì— ëŒ€í•´ì„œë§Œ ì´ˆê¸°í™” ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‹¤í–‰í•œë‹¤.
  - `never` - ì´ˆê¸°í™” ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‹¤í–‰í•˜ì§€ ì•ŠëŠ”ë‹¤.

ê¸°ë³¸ì ìœ¼ë¡œ `resources/data.sql`ì˜ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‹¤í–‰ì‹œí‚¨ë‹¤.

ì‹¤í–‰ìˆœì„œëŠ” ë‹¤ìŒê³¼ ê°™ë‹¤:
1. Hibernateê°€ ì—”í‹°í‹°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ìŠ¤í‚¤ë§ˆë¥¼ ìƒì„±/ì—…ë°ì´íŠ¸ í•œë‹¤.(ddl-auto ì„¤ì •ì— ë”°ë¼)
2. schema.sqlì´ ì‹¤í–‰ëœë‹¤. (ì¡´ì¬í•˜ëŠ” ê²½ìš°)
3. data.sqlì´ ì‹¤í–‰ëœë‹¤.

```sql
INSERT INTO role (role_name)
SELECT 'ROLE_USER' FROM DUAL
WHERE NOT EXISTS (SELECT 1 FROM role WHERE role_name = 'ROLE_USER');

INSERT INTO role (role_name)
SELECT 'ROLE_ADMIN' FROM DUAL
WHERE NOT EXISTS (SELECT 1 FROM role WHERE role_name = 'ROLE_ADMIN');

INSERT INTO role (role_name)
SELECT 'ROLE_MANAGER' FROM DUAL
WHERE NOT EXISTS (SELECT 1 FROM role WHERE role_name = 'ROLE_MANAGER');
```

---

# ğŸ”„ ì‚¬ìš©ì ê¶Œí•œ ìˆ˜ì • ë¡œì§

```java
   private User updateRoles(AdminUserRolesRequest request, User user) {
        user.getUserRoles().clear();

        request.getRoles().forEach(roleName -> {
            Role role = roleRepository.findByName(roleName)
                    .orElseThrow(() -> new CustomException(ErrorCode.ROLE_NOT_FOUND));
            UserRole userRole = UserRole.createUserRole(role);
            user.addUserRole(userRole);
        });

        return user;
    }

    @Transactional
    public AdminUserResponse updateUserRoles(Long id, AdminUserRolesRequest request) {
        User findUser = userRepository.findById(id)
                .orElseThrow(() -> new CustomException(ErrorCode.USER_NOT_FOUND));

        User updateUser = updateRoles(request, findUser);

        return AdminUserResponse.builder()
                .email(updateUser.getEmail())
                .nickname(updateUser.getNickname())
                .picture(updateUser.getPicture())
                .roles(updateUser.getUserRoles().stream()
                        .map(userRole -> userRole.getRole().getName())
                        .collect(Collectors.toSet()))
                .provider(updateUser.getProvider().name())
                .build();
    }
```
`AdminUserService`ì— ìˆëŠ” ì‚¬ìš©ìì˜ ê¶Œí•œì„ ìˆ˜ì •í•˜ëŠ” ë¡œì§ì´ë‹¤.  

**orphanRemoval = true**
- ëª©ì : Userì™€ì˜ ê´€ê³„ê°€ ëŠê¸´ UserRole ìë™ìœ¼ë¡œ ì‚­ì œ
- ë™ì‘: `user.getUserRoles().clear()`ëŠ” í•´ë‹¹ Userì— ì—°ê´€ ëª¨ë“  UserRoleì„ ì œê±°í•˜ëŠ” ì—­í• ì„ í•œë‹¤. ë”°ë¼ì„œ ì—°ê´€ëœ ëª¨ë“  UserRole ì—”í‹°í‹°ê°€ ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ì‚­ì œëœë‹¤.

**cascade = CascadeType.ALL**
- ëª©ì : User ì—”í‹°í‹° ë³€ê²½ ì‹œ ì—°ê´€ëœ UserRole ìë™ ë°˜ì˜
- ë™ì‘:
  - `user.addUserRole(userRole)`ë¡œ Userë¥¼ ë³€ê²½í–ˆì§€ë§Œ ì—°ê´€ëœ UserRoleì˜ ë³€ê²½ ì‚¬í•­ë„ ìë™ ê°ì§€ë˜ì–´ ì¶”ê°€ë˜ê±°ë‚˜ ì œê±°ëœ ì—­í• ì´ ë°ì´í„°ë² ì´ìŠ¤ì— ë°˜ì˜ëœë‹¤.

---

# ğŸ” ì‚¬ìš©ì ì „ì²´ ì¡°íšŒ í˜ì´ì§• ìµœì í™”

```java
    @Transactional(readOnly = true)
    public AdminUserListResponse getAllUsers(int page, int size) {
        Page<User> userPage = userRepository.findAllActiveUsers(PageRequest.of(page, size));

        List<AdminUserResponse> adminUserResponse = userPage.getContent().stream()
                .map(this::convertToAdminUserResponse)
                .collect(Collectors.toList());

        return AdminUserListResponse.builder()
                .users(adminUserResponse)
                .totalPages(userPage.getTotalPages())
                .totalElements(userPage.getTotalElements())
                .currentPage(userPage.getNumber())
                .build();
    }

    private AdminUserResponse convertToAdminUserResponse(User user) {
        Set<String> roles = user.getUserRoles().stream()
                .map(userRole -> userRole.getRole().getName())
                .collect(Collectors.toSet());

        return AdminUserResponse.builder()
                .email(user.getEmail())
                .roles(roles)
                .provider(user.getProvider().name())
                .nickname(user.getNickname())
                .build();
    }
```

[ê¹ƒí—ˆë¸Œ ì½”ë“œ](https://github.com/ijnooyah/admin-project/commit/b9f0f72b5ad115d5a9f36af968fda44dcc7f23b1)  
`AdminUserService`ì— ìˆëŠ” ì‚¬ìš©ì ì „ì²´ ì¡°íšŒ í˜ì´ì§• ë¡œì§ì´ë‹¤. 

**ë¬¸ì œ ìƒí™©**  
- í˜ì´ì§• + ì»¬ë ‰ì…˜ ì—”í‹°í‹° ë™ì‹œ ì¡°íšŒ ì‹œ ì„±ëŠ¥ ì´ìŠˆ ë°œìƒ
- N+1 ë¬¸ì œ: ì—°ê´€ëœ ì—”í‹°í‹°ë¥¼ ì¡°íšŒí•  ë•Œë§ˆë‹¤ ì¶”ê°€ ì¿¼ë¦¬ ë°œìƒ

**ìµœì í™” ì „ëµ**  
- `application.yml`ì— `hibernate.default_batch_fetch_size` ì ìš©

**ìµœì í™” íš¨ê³¼**
- ì¿¼ë¦¬ í˜¸ì¶œ ìˆ˜ ê°ì†Œ: `1 + N` -> `1 + 1`
- DB ë°ì´í„° ì „ì†¡ëŸ‰ ê°ì†Œ
  ```
  select
    ur1_0.user_id,
    ur1_0.user_role_id,
    ur1_0.role_id
  from
    user_role ur1_0
  where
    ur1_0.user_id in (?, ?, ?, ?, ?, ?, ?,...)

  select
    r1_0.role_id,
    r1_0.role_name
  from
    role r1_0
  where
    r1_0.role_id in (?, ?, ?, ?, ?, ?, ?,...)
  ```

> `default_batch_fetch_size` ì˜ í¬ê¸°ëŠ” ì ë‹¹í•œ ì‚¬ì´ì¦ˆë¥¼ ê³¨ë¼ì•¼ í•˜ëŠ”ë°, 100~1000 ì‚¬ì´ë¥¼ ì„ íƒí•˜ëŠ”
ê²ƒì„ ê¶Œì¥í•œë‹¤. ì´ ì „ëµì„ SQL IN ì ˆì„ ì‚¬ìš©í•˜ëŠ”ë°, ë°ì´í„°ë² ì´ìŠ¤ì— ë”°ë¼ IN ì ˆ íŒŒë¼ë¯¸í„°ë¥¼ 1000ìœ¼ë¡œ ì œí•œí•˜ê¸°
ë„ í•œë‹¤. 1000ìœ¼ë¡œ ì¡ìœ¼ë©´ í•œë²ˆì— 1000ê°œë¥¼ DBì—ì„œ ì• í”Œë¦¬ì¼€ì´ì…˜ì— ë¶ˆëŸ¬ì˜¤ë¯€ë¡œ DBì— ìˆœê°„ ë¶€í•˜ê°€ ì¦ê°€í•  ìˆ˜
ìˆë‹¤. **í•˜ì§€ë§Œ ì• í”Œë¦¬ì¼€ì´ì…˜ì€ 100ì´ë“  1000ì´ë“  ê²°êµ­ ì „ì²´ ë°ì´í„°ë¥¼ ë¡œë”©í•´ì•¼ í•˜ë¯€ë¡œ ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ì´ ê°™ë‹¤.**
1000ìœ¼ë¡œ ì„¤ì •í•˜ëŠ” ê²ƒì´ ì„±ëŠ¥ìƒ ê°€ì¥ ì¢‹ì§€ë§Œ, ê²°êµ­ DBë“  ì• í”Œë¦¬ì¼€ì´ì…˜ì´ë“  ìˆœê°„ ë¶€í•˜ë¥¼ ì–´ë””ê¹Œì§€ ê²¬ë”œ ìˆ˜ ìˆëŠ”
ì§€ë¡œ ê²°ì •í•˜ë©´ ëœë‹¤.  
\- ê¹€ì˜í•œë‹˜ JPA ê°•ì˜ -
{: .info}

---

# ğŸ§ª í…ŒìŠ¤íŠ¸ í™˜ê²½ ì„¤ì •
`/test/resources/application.yml`ì— ë‹¤ìŒê³¼ ê°™ì€ ì½”ë“œë¥¼ ì‘ì„±í–ˆë‹¤.
```yml
spring:
  datasource:
    driver-class-name: org.h2.Driver
    url: jdbc:h2:mem:testdb
    username: sa
    password:

  jpa:
    hibernate:
      ddl-auto: none
    properties:
      hibernate:
        format_sql: true
        default_batch_fetch_size: 1000
    defer-datasource-initialization: false

  sql:
    init:
      mode: always

  data:
    redis:
      host: localhost
      port: 6379

# Test OAuth
  security:
    oauth2:
      client:
        registration:
          google:
            client-id: test
            client-secret: test
            scope: profile,email
          naver:
            client-id: test
            client-secret: test
            redirect-uri: "{baseUrl}/login/oauth2/code/{registrationId}"
            authorization-grant-type: authorization_code
            scope: email,name,profile_image
        provider:
          naver:
            authorization-uri: https://nid.naver.com/oauth2.0/authorize
            token-uri: https://nid.naver.com/oauth2.0/token
            user-info-uri: https://openapi.naver.com/v1/nid/me
            user-name-attribute: response

logging.level:
  org.hibernate.SQL: debug
  com.yoonji.adminproject: debug
```
- H2 ì¸ë©”ëª¨ë¦¬ ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ì‚¬ìš©
- JPA `ddl-auto`ë¥¼ `none`ìœ¼ë¡œ ì„¤ì •í•´ ìŠ¤í‚¤ë§ˆ ìë™ ìƒì„± ë¹„í™œì„±í™”
- OAuth í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•œ ë”ë¯¸ ì„¤ì •

<br>

`test/resources/schema.sql`
```sql
CREATE TABLE IF NOT EXISTS role
(
    role_id    BIGINT GENERATED BY DEFAULT AS IDENTITY NOT NULL,
    created_at TIMESTAMP,
    updated_at TIMESTAMP,
    role_name  VARCHAR(255),
    CONSTRAINT pk_role PRIMARY KEY (role_id)
);

CREATE TABLE IF NOT EXISTS  users
(
    user_id    BIGINT GENERATED BY DEFAULT AS IDENTITY NOT NULL,
    created_at TIMESTAMP,
    updated_at TIMESTAMP,
    nickname   VARCHAR(255),
    email      VARCHAR(255),
    picture    VARCHAR(255),
    password   VARCHAR(255),
    provider   VARCHAR(255),
    deleted    BOOLEAN                                 NOT NULL,
    deleted_at TIMESTAMP,
    CONSTRAINT pk_users PRIMARY KEY (user_id)
);

CREATE TABLE IF NOT EXISTS  user_role
(
    user_role_id BIGINT GENERATED BY DEFAULT AS IDENTITY NOT NULL,
    created_at   TIMESTAMP,
    updated_at   TIMESTAMP,
    user_id      BIGINT,
    role_id      BIGINT,
    CONSTRAINT pk_user_role PRIMARY KEY (user_role_id)
);

ALTER TABLE user_role
    ADD CONSTRAINT FK_USER_ROLE_ON_ROLE FOREIGN KEY (role_id) REFERENCES role (role_id);

ALTER TABLE user_role
    ADD CONSTRAINT FK_USER_ROLE_ON_USER FOREIGN KEY (user_id) REFERENCES users (user_id);
```
<br>

`test/resources/data.sql`
```sql
INSERT INTO role (role_name)
SELECT 'ROLE_USER'
    WHERE NOT EXISTS (SELECT 1 FROM role WHERE role_name = 'ROLE_USER');

INSERT INTO role (role_name)
SELECT 'ROLE_ADMIN'
    WHERE NOT EXISTS (SELECT 1 FROM role WHERE role_name = 'ROLE_ADMIN');

INSERT INTO role (role_name)
SELECT 'ROLE_MANAGER'
    WHERE NOT EXISTS (SELECT 1 FROM role WHERE role_name = 'ROLE_MANAGER');
```



